@page "/calendar"
@using MoodAtlas.Services
@using MoodAtlas.Models
@inject UserService UserService
@inject EntryService EntryService
@inject MoodService MoodService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="min-vh-100">
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
        <div class="container-fluid">
            <span class="navbar-brand fw-bold">MoodAtlas Calendar</span>
            <div class="ms-auto d-flex align-items-center gap-3">
                <span class="text-white">Welcome, <strong>@currentUser?.Username</strong></span>
                <button class="btn btn-outline-light btn-sm" @onclick="GoToDashboard">Dashboard</button>
            </div>
        </div>
    </nav>

    <!-- Navigation Tabs -->
    <div class="container-fluid pt-4">
        <div class="nav nav-tabs mb-4" role="tablist">
            <a href="/dashboard-enhanced/@currentUser?.UserId" class="nav-link">Dashboard</a>
            <a href="/entry-editor" class="nav-link">New Entry</a>
            <a href="/entries" class="nav-link">Entries</a>
            <a href="/calendar" class="nav-link active">Calendar</a>
            <button class="nav-link ms-auto theme-toggle" @onclick="ToggleTheme" style="border: none; background: none; cursor: pointer;">
                @(isDarkMode ? "Light Mode" : "Dark Mode")
            </button>
        </div>
    </div>

    <div class="container">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                @errorMessage
                <button type="button" class="btn-close" @onclick="() => errorMessage = null"></button>
            </div>
        }

        @if (isLoading)
        {
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading calendar...</p>
            </div>
        }
        else
        {
            <div class="card border-0 shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">Journal Calendar</h4>
                        <small>Click on a date to view or edit entries</small>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-outline-light btn-sm" @onclick="PreviousMonth">Previous</button>
                        <h5 class="mb-0 mx-3">@currentMonth.ToString("MMMM yyyy")</h5>
                        <button class="btn btn-outline-light btn-sm" @onclick="NextMonth">Next</button>
                        <button class="btn btn-outline-light btn-sm ms-3" @onclick="GoToToday">Today</button>
                    </div>
                </div>

                <div class="card-body">
                    <!-- Calendar Grid -->
                    <div class="calendar-grid">
                        <!-- Day headers -->
                        <div class="calendar-row day-headers">
                            @foreach (var day in dayNames)
                            {
                                <div class="calendar-cell day-header">@day</div>
                            }
                        </div>

                        <!-- Calendar cells -->
                        @for (int week = 0; week < 6; week++)
                        {
                            <div class="calendar-row">
                                @for (int day = 0; day < 7; day++)
                                {
                                    var dateIndex = week * 7 + day;
                                    if (dateIndex < calendarDays.Count)
                                    {
                                        var calendarDay = calendarDays[dateIndex];
                                        <div class="calendar-cell @GetCellClass(calendarDay)" @onclick="() => OnDayClick(calendarDay)">
                                            <div class="date-number @(!calendarDay.IsCurrentMonth ? "text-muted" : "")">
                                                @calendarDay.Date.Day
                                            </div>
                                            @if (calendarDay.HasEntry)
                                            {
                                                <div class="entry-indicator">
                                                    <span class="mood-indicator-dot" style="background-color: @GetMoodColorForDay(calendarDay);"></span>
                                                </div>
                                                <div class="entry-preview">
                                                    @calendarDay.EntryTitle
                                                </div>
                                            }
                                            else if (calendarDay.IsCurrentMonth)
                                            {
                                                <div class="add-entry-hint">
                                                    <small class="text-muted">+</small>
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            </div>
                        }
                    </div>

                    <!-- Legend -->
                    <div class="calendar-legend mt-4">
                        <h6>Legend:</h6>
                        <div class="d-flex flex-wrap gap-3 mt-2">
                            <div class="d-flex align-items-center">
                                <div class="legend-color" style="background-color: #4CAF50;"></div>
                                <span class="ms-2">Positive Mood</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="legend-color" style="background-color: #FF9800;"></div>
                                <span class="ms-2">Neutral Mood</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="legend-color" style="background-color: #F44336;"></div>
                                <span class="ms-2">Negative Mood</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="legend-color" style="background-color: #e0e0e0;"></div>
                                <span class="ms-2">No Entry</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="legend-color" style="border: 2px solid #667eea;"></div>
                                <span class="ms-2">Today</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<style>
    .calendar-grid {
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 8px;
        overflow: hidden;
    }

    .calendar-row {
        display: flex;
        min-height: 100px;
    }

    .calendar-cell {
        flex: 1;
        border: 1px solid var(--border-color, #dee2e6);
        padding: 8px;
        position: relative;
        transition: background-color 0.2s;
        cursor: pointer;
    }

    .calendar-cell:hover {
        background-color: var(--bg-hover, rgba(102, 126, 234, 0.1));
    }

    .day-headers {
        background-color: var(--bg-tertiary, #f8f9fa);
        font-weight: bold;
        min-height: 40px;
    }

    .day-header {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: default;
    }

    .date-number {
        font-weight: bold;
        font-size: 1rem;
        margin-bottom: 5px;
    }

    .entry-indicator {
        position: absolute;
        top: 5px;
        right: 5px;
    }

    .mood-indicator-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }

    .entry-preview {
        font-size: 0.75rem;
        margin-top: 5px;
        padding: 2px 4px;
        border-radius: 4px;
        background-color: var(--bg-card, rgba(255,255,255,0.7));
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .add-entry-hint {
        position: absolute;
        bottom: 5px;
        right: 5px;
        opacity: 0;
        transition: opacity 0.2s;
    }

    .calendar-cell:hover .add-entry-hint {
        opacity: 1;
    }

    .calendar-legend {
        padding: 15px;
        background-color: var(--bg-tertiary, #f8f9fa);
        border-radius: 8px;
    }

    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
    }

    .has-entry {
        background-color: rgba(102, 126, 234, 0.05);
    }

    .today {
        border: 2px solid #667eea !important;
        background-color: rgba(102, 126, 234, 0.1);
    }

    .positive-mood {
        background-color: rgba(76, 175, 80, 0.15) !important;
        border-left: 3px solid #4CAF50;
    }

    .neutral-mood {
        background-color: rgba(255, 152, 0, 0.15) !important;
        border-left: 3px solid #FF9800;
    }

    .negative-mood {
        background-color: rgba(244, 67, 54, 0.15) !important;
        border-left: 3px solid #F44336;
    }
</style>

@code {
    private User currentUser;
    private bool isDarkMode = false;
    private bool isLoading = true;
    private string errorMessage;
    private DateTime currentMonth = DateTime.Now;
    private List<CalendarDay> calendarDays = new();
    private List<Entry> userEntries = new();
    private Dictionary<DateTime, Entry> entriesByDate = new();
    private Dictionary<int, List<Mood>> moodsByEntryId = new();

    private string[] dayNames = { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" };

    public class CalendarDay
    {
        public DateTime Date { get; set; }
        public bool IsCurrentMonth { get; set; }
        public bool IsToday { get; set; }
        public bool HasEntry { get; set; }
        public Entry Entry { get; set; }
        public List<Mood> Moods { get; set; } = new();
        public string EntryTitle => Entry?.Title?.Length > 12 ? Entry.Title.Substring(0, 12) + "..." : Entry?.Title ?? "";
        public string MoodCategory => Moods?.FirstOrDefault()?.Category ?? "";
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            
            var users = await UserService.GetAllUsersAsync();
            currentUser = users?.FirstOrDefault();

            if (currentUser == null)
            {
                Navigation.NavigateTo("/login");
                return;
            }

            isDarkMode = currentUser.IsDarkMode;
            await JS.InvokeVoidAsync("applyTheme", isDarkMode);
            
            await LoadEntriesAndMoods();
            GenerateCalendar();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading calendar: {ex.Message}");
            errorMessage = $"Error loading calendar: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadEntriesAndMoods()
    {
        try
        {
            userEntries = await EntryService.GetEntriesByUserIdAsync(currentUser.UserId) ?? new List<Entry>();
            
            entriesByDate = new Dictionary<DateTime, Entry>();
            foreach (var entry in userEntries)
            {
                var dateKey = entry.EntryDate.Date;
                if (!entriesByDate.ContainsKey(dateKey))
                {
                    entriesByDate[dateKey] = entry;
                }
            }

            moodsByEntryId = new Dictionary<int, List<Mood>>();
            foreach (var entry in userEntries)
            {
                try
                {
                    var moods = await MoodService.GetMoodsForEntryAsync(entry.EntryId);
                    moodsByEntryId[entry.EntryId] = moods ?? new List<Mood>();
                }
                catch
                {
                    moodsByEntryId[entry.EntryId] = new List<Mood>();
                }
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Error loading entries: {ex.Message}");
            throw;
        }
    }

    private void GenerateCalendar()
    {
        calendarDays.Clear();

        var firstDayOfMonth = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        var daysInMonth = DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);

        int startDay = (int)firstDayOfMonth.DayOfWeek;

        for (int i = startDay - 1; i >= 0; i--)
        {
            var date = firstDayOfMonth.AddDays(-(i + 1));
            calendarDays.Add(CreateCalendarDay(date, false));
        }

        for (int day = 1; day <= daysInMonth; day++)
        {
            var date = new DateTime(currentMonth.Year, currentMonth.Month, day);
            calendarDays.Add(CreateCalendarDay(date, true));
        }

        int remainingCells = 42 - calendarDays.Count;
        var nextMonthStart = new DateTime(currentMonth.Year, currentMonth.Month, 1).AddMonths(1);

        for (int i = 0; i < remainingCells; i++)
        {
            var date = nextMonthStart.AddDays(i);
            calendarDays.Add(CreateCalendarDay(date, false));
        }
    }

    private CalendarDay CreateCalendarDay(DateTime date, bool isCurrentMonth)
    {
        var calendarDay = new CalendarDay
        {
            Date = date,
            IsCurrentMonth = isCurrentMonth,
            IsToday = date.Date == DateTime.Now.Date
        };

        if (entriesByDate.TryGetValue(date.Date, out var entry))
        {
            calendarDay.HasEntry = true;
            calendarDay.Entry = entry;
            
            if (moodsByEntryId.TryGetValue(entry.EntryId, out var moods))
            {
                calendarDay.Moods = moods;
            }
        }

        return calendarDay;
    }

    private string GetCellClass(CalendarDay day)
    {
        var classes = new List<string>();

        if (day.IsToday)
            classes.Add("today");

        if (day.HasEntry)
        {
            classes.Add("has-entry");
            
            if (!string.IsNullOrEmpty(day.MoodCategory))
            {
                classes.Add($"{day.MoodCategory.ToLower()}-mood");
            }
        }

        return string.Join(" ", classes);
    }

    private string GetMoodColorForDay(CalendarDay day)
    {
        if (day.Moods != null && day.Moods.Any())
        {
            var primaryMood = day.Moods.First();
            return primaryMood.Category switch
            {
                "Positive" => "#4CAF50",
                "Neutral" => "#FF9800",
                "Negative" => "#F44336",
                _ => "#667eea"
            };
        }
        return "#667eea";
    }

    private void OnDayClick(CalendarDay day)
    {
        if (day.HasEntry && day.Entry != null)
        {
            // Edit existing entry
            Navigation.NavigateTo($"/entry-editor/{day.Entry.EntryId}");
        }
        else if (day.IsCurrentMonth)
        {
            // Create new entry for this date
            Navigation.NavigateTo($"/entry-editor");
        }
    }

    private async Task PreviousMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        GenerateCalendar();
        await InvokeAsync(StateHasChanged);
    }

    private async Task NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        GenerateCalendar();
        await InvokeAsync(StateHasChanged);
    }

    private void GoToToday()
    {
        currentMonth = DateTime.Now;
        GenerateCalendar();
    }

    private void GoToDashboard()
    {
        Navigation.NavigateTo($"/dashboard-enhanced/{currentUser?.UserId ?? 1}");
    }

    private async Task ToggleTheme()
    {
        isDarkMode = !isDarkMode;
        if (currentUser != null)
        {
            currentUser.IsDarkMode = isDarkMode;
            await UserService.UpdateUserAsync(currentUser);
        }
        await JS.InvokeVoidAsync("applyTheme", isDarkMode);
    }
}